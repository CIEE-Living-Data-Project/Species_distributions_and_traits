---
title: "Setting up zoop data matrices per season & year"
author: "meganedeziel"
date: "2023-08-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(FD)
library(vegan)
library(here)
library(ggplot2)
```

#1 - Data importation
```{r}
# species x trait matrix
here("data")
trait<-load(here("data", "curated_species_trait_matrices_20230814.RData")) #we have one matrix of binary traits (trophic group, feeding mode, reprod. mode) and one numerical
#only one trait is actually coded as binary: FM:particle feeder
traits.all<-left_join(traits.SOG.num.mat, traits.SOG.bin.mat, by="scientificName")

# abundance data
abun<-load(here("data", "curated_zoop_distribution_20230801.RData"))
abun_mat<-zoop.SOG[zoop.SOG$scientificName %in% traits.all$scientificName, ] #all species in the abundance dataset are present in the trait matrix
```
Notes on the abundance dataset:
141 species, we have trait data for all the species in the abundance matrix.
Data was collected in two regions: Central Strait of Georgia, Northern Strait of Georgia
49 stations in Central Strait of Georgia
56 stations in Northern Strait of Georgia

#1.5 - A bit more data wrangling
Notes: 
1. The unit of samples is the sample or "Index" column and so there may be repeated sampling within the same region-station-year-season. This means that to get to the per season/year resolution, abundances and biomass need to be averaged. 
abun_mat %>%
  distinct(Index, Region, Station, Year, Season) %>%
  group_by(Region, Station, Year, Season) %>% 
  count() %>% 
  filter(n>1)

2. Because the different stations have different depths, a typical procedure to average across stations or compare stations is to convert the per volume (/m3) abundance and biomass to per area (/m2). This is done by multiplying abundance/m3 or biomass/m3 with the tow depth resulting in the total amount of a species collected in a plankton net.
3. When doing the averaging, instances of zero abundance or biomass for a species should be considered.
4. A common practice when averaging to per season is averaging per month first then season to get a more even representation of a season.

5. 
```{r}
# sites x species
abun_mat <- abun_mat %>% 
  # sum abundance and biomass to species level across life stages or size classes
  group_by(Index, Region, Station, Longitude, Latitude,
           Year, Season, Month, scientificName) %>% 
  # Also convert from abundance or biomass /m3 to /m2
  summarise(Abundance = sum(`Abundance(indiv/m3)`*`Tow_start_depth(m)`),
            Biomass = sum(`Biomass(mg/m3)`*`Tow_start_depth(m)`),
            .groups = "drop") 

# Convert to matrices to pad 0 abundance or biomass
abun_mat.abun <- abun_mat %>% 
  select(Index, scientificName, Abundance) %>% 
  pivot_wider(names_from = scientificName, values_from = Abundance,
              values_fill = 0) %>% 
  pivot_longer(cols = -Index, 
               names_to = "scientificName", values_to = "Abundance")
abun_mat.biom <- abun_mat %>% 
  select(Index, scientificName, Biomass) %>% 
  pivot_wider(names_from = scientificName, values_from = Biomass,
              values_fill = 0) %>% 
  pivot_longer(cols = -Index, 
               names_to = "scientificName", values_to = "Biomass")

# merge the padded abundance and biomass data frames together
abun_mat <- abun_mat %>% 
  distinct(Index, Region, Station, Longitude, Latitude,
           Year, Season, Month) %>% 
  left_join(abun_mat.abun, by = "Index") %>% 
  left_join(abun_mat.biom, by = c("Index","scientificName"))

rm(abun_mat.abun, abun_mat.biom)


# # Example of averaging per season after averaging by month
# abun_per_season <- abun_mat %>% 
#   group_by(scientificName, Region, Station, Year, Season, Month) %>% 
#   summarise(Abundance = mean(Abundance),
#          Biomass = mean(Biomass), .groups = "drop") %>% 
#   group_by(scientificName, Region, Station, Year, Season) %>% 
#   summarise(Abundance = mean(Abundance),
#          Biomass = mean(Biomass), .groups = "drop") %>% 
#   mutate(seasonxyear_id=paste(Season, Year, sep="_"))

```

#2 - Calculate abundance and biomass per year AND per season in each year
```{r}
#create a row for mean abundance and biomass for each species (average the rows with different “Size_class_or_life_stage”)
abun_per_season<-abun_mat %>%
  group_by(scientificName, Region, Station, Year, Season) %>%
  mutate(biomass_per_season=sum(`Biomass(mg/m3)`)) %>% #calc total biomass per season
  mutate(abundance_per_season=sum(`Abundance(indiv/m3)`)) %>% #calc total abundance per season
  ungroup() %>%
  select(scientificName, majorgroup, Region, Station, Longitude, Latitude, Year, Season, biomass_per_season, abundance_per_season) %>%
  unique() %>%
  group_by(Region, Station, Year, Season) %>%
  mutate(rel_biomass_per_season=biomass_per_season/sum(biomass_per_season)) %>% #relative biomass per season
  mutate(rel_abundance_per_season=abundance_per_season/sum(abundance_per_season)) %>% #relative abundance per season
  ungroup() %>%
  mutate(seasonxyear_id=paste(Season, Year, sep="_"))

abun_per_year<-abun_per_season %>%
  group_by(scientificName, Region, Station, Year) %>%
  mutate(biomass_per_year=sum(biomass_per_season)) %>% #calc total biomass per year
  mutate(abundance_per_year=sum(abundance_per_season)) %>% #calc total abundance per year
  ungroup() %>%
  select(scientificName, majorgroup, Region, Station, Longitude, Latitude, Year, biomass_per_year, abundance_per_year) %>%
  unique() %>%
  group_by(Region, Station, Year) %>%
  mutate(rel_biomass_per_year=biomass_per_year/sum(biomass_per_year)) %>%
  mutate(rel_abundance_per_year=abundance_per_year/sum(abundance_per_year)) %>%
  ungroup()
```

#3 Splitting the dataframe in different matrices for each season and year, put them in wide format
```{r}
#I need one different matrix for each season within a year and for each year - I'll create a list of matrices

#MD: Hello Patrick! So what I wanted was to create different matrices for every year and for every season within a year.
#I think I finally fixed it, and Yes, I was possible to achieve this with some extra group_by prior to pivoting the matrices in wide format.
#So this is what I did with the group_byS above, and below I am dividing the 2 big dataframes abun_per_season and abun_per_year in different matrices for each season and year.
# TODO: PP: The script here seems to work as it is written. Why are the dataframes in nested lists rather than site x species matrices?

### MATRICES PER SEASON WITHIN A YEAR
#List of matrices of ABUNDANCE
abun_per_season_l<-abun_per_season %>%
  select(c(1:6, 13, 10)) %>%
  pivot_wider(names_from=Station, values_from=abundance_per_season) %>%
  group_by(seasonxyear_id) %>%
  nest() 

#List of matrices of RELATIVE ABUNDANCE
rel_abun_per_season_l<-abun_per_season %>%
  select(c(1:6, 13, 12)) %>%
  pivot_wider(names_from=Station, values_from=rel_abundance_per_season) %>%
  group_by(seasonxyear_id) %>%
  nest() 

#List of matrices of BIOMASS
biom_per_season_l<-abun_per_season %>%
  select(c(1:6, 13, 9)) %>%
  pivot_wider(names_from=Station, values_from=biomass_per_season) %>%
  group_by(seasonxyear_id) %>%
  nest() 

#List of matrices of RELATIVE BIOMASS
rel_biom_per_season_l<-abun_per_season %>%
  select(c(1:6, 13, 11)) %>%
    pivot_wider(names_from=Station, values_from=rel_biomass_per_season) %>%
  group_by(seasonxyear_id) %>%
  nest() 

### MATRICES PER YEAR
#List of matrices of ABUNDANCE 
abun_per_year_l<-abun_per_year %>%
  select(c(1:7, 9)) %>%
  pivot_wider(names_from=Station, values_from=abundance_per_year) %>%
  group_by(Year) %>%
  nest()

#List of matrices of RELATIVE ABUNDANCE
rel_abun_per_year_l<-abun_per_year %>%
  select(c(1:7, 11)) %>%
  pivot_wider(names_from=Station, values_from=rel_abundance_per_year) %>%
  group_by(Year) %>%
  nest()

#List of matrices of BIOMASS
biom_per_year_l<-abun_per_year %>%
  select(c(1:8)) %>%
  pivot_wider(names_from=Station, values_from=biomass_per_year) %>%
  group_by(Year) %>%
  nest()

rel_biom_per_year_l<-abun_per_year %>%
  select(c(1:7, 10)) %>%
  pivot_wider(names_from=Station, values_from=rel_biomass_per_year) %>%
  group_by(Year) %>%
  nest()

#Here we see that for some years only 1 station was sampled (ex: in 1996, only station GEO1 was sampled.)
```

We now have 8 different lists of matrices (well, they are still class df):
abun_per_season_l
rel_abun_per_season_l
biom_per_season_l
rel_biom_per_season_l
abun_per_year_l
rel_abun_per_year_l
biom_per_year_l
rel_biom_per_year_l

We will be able to iterate over these lists to calculate different indices for every season or year.

